version: "3.8"

services:
  # MongoDB Database Service
  mongo:
    image: mongo:7.0
    container_name: mubeen-auth-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: mubeen-auth
    volumes:
      - mongo_data:/data/db
    networks:
      - mubeen-auth-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/mubeen-auth --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Backend API Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mubeen-auth-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongo:27017/mubeen-auth
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRY=${JWT_EXPIRY:-7d}
      - REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY:-30d}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_VERIFY_SERVICE_SID=${TWILIO_VERIFY_SERVICE_SID}
      - OTP_EXPIRY_MINUTES=${OTP_EXPIRY_MINUTES:-10}
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_APP_PASSWORD=${EMAIL_APP_PASSWORD}
      - TEXTBELT_API_KEY=${TEXTBELT_API_KEY}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - mubeen-auth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  mongo_data:
    driver: local

networks:
  mubeen-auth-network:
    driver: bridge
